# http缓存

http缓存分为**强制缓存**和**对比缓存**

## 缓存规则

**强制缓存**

在浏览器访问服务器请求数据之前，会先向缓存数据库请求数据，如果缓存数据库有数据且数据未失效，则获取缓存数据库的数据；如果缓存数据库没有数据或缓存数据库的数据已经失效，则向服务器发起请求，获取新的数据和缓存规则，将获取到的数据和缓存规则存进缓存数据库。

**对比缓存**

在浏览器访问服务器请求数据之前，会先向缓存数据库请求获取缓存数据标识，然后向服务器发起请求，服务器验证缓存标识对应的数据是否失效，如果未失效则通知浏览器缓存数据未失效，浏览器向缓存数据库获取数据；如果已失效，服务器直接返回新的数据和缓存规则，浏览器将获取到的数据和缓存规则存进缓存数据库。

> 强制缓存优先级高于对比缓存，当强制缓存规则生效时，不会再执行对比缓存。

## 强制缓存

对于强制缓存，response header中有两个字段来标明失效规则（Expires/Cache-Control)

**Expires**
Expires的值是服务端返回的到期时间，如果请求的时间小于Expires的时间，则缓存数据有效，直接使用缓存数据。
由于到期时间是服务端生成的，客户端时间可能跟服务端时间有误差，这就会导致**缓存命中**的误差。
不过Expires是http1.0的东西，现在浏览器默认使用http1.1，所以基本没有用了。

**Cache-Control**
Cache-Control是http1.1用来替代Expires的规则，常见的取值有：
private: 客户端可以缓存
public: 客户端和代理服务器都可以缓存（对于前端来说和private没区别）
max-age=xxx: 缓存的内容将在xxx秒后失效
no-cache: 需要使用**对比缓存**来验证缓存数据
no-store: 所有内容都不会缓存，强制缓存和对比缓存都不会触发（前端基本不会用）

## 对比缓存

在对比缓存中，是通过缓存标识来判断缓存数据是否过期，缓存标识在request header和response header之间进行传递，一共分为两种：

**Last-Modified/If-Modified-Since**

Last-modified:

放在response header里面，服务器在响应请求时，告诉浏览器资源的最后修改时间。

If-modified-Since:

放在request header里面，向服务器请求时，通过此字段通知服务器上次请求时，服务器返回的资源最后修改时间。
服务器收到请求后发现If-Modified-Since则与被请求资源的最后修改时间进行比对，若资源的最后修改时间大于If-Modified-Since，说明资源有被改动过，则返回新的资源内容，返回状态码200；若资源的最后修改时间小于或等于If-Modified-Since，说明资源无新修改，则返回状态码304，告知浏览器使用缓存数据库中的资源。

**Etag/If-None-Match**

Etag:

放在response header，服务器相应请求时，告诉浏览器当前资源在服务器的唯一标识（生成规则由服务器决定）

If-None-Matcdh:

放在request header，向服务器请求时，通过此字段通知服务器客户端缓存数据的唯一标识。
服务器收到请求后发现If-None-Match则与被请求资源的唯一标识进行比对，如果不同，说明资源有被改动过，则返回新的资源内容，返回状态码200；如果相同，说明资源无新修改，则返回状态码304，告知浏览器使用缓存数据库中的资源。

## 总结

对于强制缓存，服务器通知浏览器一个缓存时间，在缓存时间内，下次请求直接使用缓存，不在时间内则执行比较缓存策略。
对于比较缓存，将缓存信息中的Etag和Last-Modified通过请求发送给服务器，由服务器校验，返回304状态码时，浏览器直接使用缓存。

## 参考

+ [彻底弄懂htt缓存机制及原理](https://www.cnblogs.com/chenqf/p/6386163.html)